#!/usr/bin/env bash
# Stillwater LLM Portal — Unified Control Script
# Auth: 65537 | Port: 8788
# Usage:
#   ./admin/llm_portal start [--dev]
#   ./admin/llm_portal stop
#   ./admin/llm_portal status
#   ./admin/llm_portal log [lines]

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
PID_FILE="$SCRIPT_DIR/.llm-portal.pid"
LOG_FILE="$SCRIPT_DIR/.llm-portal.log"
PORT="${LLM_PORTAL_PORT:-8788}"
HOST="${LLM_PORTAL_HOST:-0.0.0.0}"

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ============================================================
# Helper Functions
# ============================================================

die() {
  echo -e "${RED}❌ $1${NC}" >&2
  exit 1
}

info() {
  echo -e "${GREEN}✅ $1${NC}"
}

warn() {
  echo -e "${YELLOW}⚠️  $1${NC}"
}

# Check if process is alive
is_running() {
  [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null
}

# Verify dependencies
check_dependencies() {
  python3 -c "import fastapi, uvicorn" 2>/dev/null || \
    die "Missing dependencies. Run: pip install 'fastapi[standard]' uvicorn httpx"

  python3 -c "from stillwater.llm_client import llm_call" 2>/dev/null || \
    die "stillwater.llm_client not importable. Run: pip install -e cli/ --quiet"
}

# ============================================================
# Commands
# ============================================================

cmd_start() {
  local dev_mode=false
  [[ "${1:-}" == "--dev" ]] && dev_mode=true

  # Check if already running
  if is_running; then
    PID=$(cat "$PID_FILE")
    info "Already running (PID $PID)"
    echo "   URL:  http://localhost:$PORT"
    echo "   Stop: $SCRIPT_DIR/llm_portal stop"
    return 0
  fi

  check_dependencies
  cd "$REPO_ROOT"

  echo ""
  echo "============================================================"
  echo "  Stillwater LLM Portal — Starting"
  echo "============================================================"

  if $dev_mode; then
    echo "  Mode:  DEV (auto-reload)"
    echo "  URL:   http://localhost:$PORT"
    echo "  Press Ctrl+C to stop"
    echo "============================================================"
    python3 -m uvicorn admin.llm_portal:app \
      --host "$HOST" --port "$PORT" --reload
  else
    # Background mode
    nohup python3 -m uvicorn admin.llm_portal:app \
      --host "$HOST" --port "$PORT" \
      > "$LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"

    # Wait up to 10s for it to start (more tolerant than 5s)
    for i in {1..10}; do
      sleep 1
      if curl -sf "http://localhost:$PORT/api/health" >/dev/null 2>&1; then
        info "Started (PID $(cat "$PID_FILE"))"
        echo "  URL:  http://localhost:$PORT"
        echo "  Log:  $LOG_FILE"
        echo "  Stop: $SCRIPT_DIR/llm_portal stop"
        echo "============================================================"
        return 0
      fi
    done

    # Check if process is alive (might still be starting)
    if is_running; then
      warn "Process started but health check timed out (may still be starting)"
      echo "  PID:  $(cat "$PID_FILE")"
      echo "  URL:  http://localhost:$PORT"
      echo "  Log:  $LOG_FILE"
      echo "  Check status: $SCRIPT_DIR/llm_portal status"
      echo "============================================================"
      return 0
    else
      die "Failed to start — check log: tail -20 $LOG_FILE"
    fi
  fi
}

cmd_stop() {
  if [[ ! -f "$PID_FILE" ]]; then
    warn "LLM Portal is not running (no PID file)"
    return 0
  fi

  PID=$(cat "$PID_FILE")

  if kill -0 "$PID" 2>/dev/null; then
    # Try graceful shutdown first
    kill "$PID"

    # Wait up to 5s for graceful shutdown
    for i in {1..5}; do
      sleep 1
      if ! kill -0 "$PID" 2>/dev/null; then
        rm -f "$PID_FILE"
        info "Stopped (PID $PID)"
        return 0
      fi
    done

    # Force kill if still running
    kill -9 "$PID" 2>/dev/null || true
    rm -f "$PID_FILE"
    warn "Force-stopped (PID $PID) — did not shut down gracefully"
  else
    warn "Was not running (stale PID $PID)"
    rm -f "$PID_FILE"
  fi
}

cmd_status() {
  echo ""
  echo "============================================================"
  echo "  Stillwater LLM Portal — Status"
  echo "============================================================"

  # Process status
  if [[ -f "$PID_FILE" ]]; then
    PID=$(cat "$PID_FILE")
    if kill -0 "$PID" 2>/dev/null; then
      echo "  Process:  ✅ Running (PID $PID)"
      echo "  URL:      http://localhost:$PORT"
    else
      echo "  Process:  ❌ Dead (stale PID $PID)"
    fi
  else
    echo "  Process:  ⏹  Not running"
  fi

  # HTTP health check
  if curl -sf "http://localhost:$PORT/api/health" >/dev/null 2>&1; then
    HEALTH=$(curl -sf "http://localhost:$PORT/api/health" 2>/dev/null)
    ACTIVE=$(echo "$HEALTH" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('active_provider','?'))" 2>/dev/null || echo '?')
    VERSION=$(echo "$HEALTH" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('portal_version','?'))" 2>/dev/null || echo '?')
    echo "  HTTP:     ✅ Responding (v$VERSION)"
    echo "  Provider: $ACTIVE"
  else
    echo "  HTTP:     ❌ Not responding on port $PORT"
  fi

  # Config file status
  if [[ -f "$REPO_ROOT/llm_config.yaml" ]]; then
    CONFIG_LINE=$(grep "^provider:" "$REPO_ROOT/llm_config.yaml" | head -1)
    echo "  Config:   ✅ $CONFIG_LINE"
  else
    echo "  Config:   ❌ llm_config.yaml not found"
  fi

  # Log file
  if [[ -f "$LOG_FILE" ]]; then
    SIZE=$(wc -c < "$LOG_FILE")
    echo "  Log:      $LOG_FILE ($SIZE bytes)"
  else
    echo "  Log:      (not found)"
  fi

  echo ""
  echo "  Commands:"
  echo "    Start:  $SCRIPT_DIR/llm_portal start"
  echo "    Stop:   $SCRIPT_DIR/llm_portal stop"
  echo "    Dev:    $SCRIPT_DIR/llm_portal start --dev"
  echo "    Log:    $SCRIPT_DIR/llm_portal log 50"
  echo "============================================================"
}

cmd_log() {
  local lines="${1:-20}"

  if [[ ! -f "$LOG_FILE" ]]; then
    die "Log file not found: $LOG_FILE"
  fi

  if ! [[ "$lines" =~ ^[0-9]+$ ]]; then
    die "Lines must be a number, got: $lines"
  fi

  echo ""
  echo "============================================================"
  echo "  LLM Portal Log (last $lines lines from $LOG_FILE)"
  echo "============================================================"
  echo ""
  tail -n "$lines" "$LOG_FILE"
  echo ""
  echo "============================================================"
}

# ============================================================
# Main
# ============================================================

COMMAND="${1:-status}"

case "$COMMAND" in
  start)
    cmd_start "${2:-}"
    ;;
  stop)
    cmd_stop
    ;;
  status)
    cmd_status
    ;;
  log)
    cmd_log "${2:-20}"
    ;;
  restart)
    cmd_stop
    sleep 1
    cmd_start "${2:-}"
    ;;
  *)
    cat >&2 <<EOF
Stillwater LLM Portal — Control Script (v1.1.0)

Usage:
  $SCRIPT_DIR/llm_portal start [--dev]    Start in background (or --dev for foreground)
  $SCRIPT_DIR/llm_portal stop             Stop the running portal
  $SCRIPT_DIR/llm_portal status           Show status (default)
  $SCRIPT_DIR/llm_portal log [N]          Show last N log lines (default: 20)
  $SCRIPT_DIR/llm_portal restart [--dev]  Stop and start

Environment variables:
  LLM_PORTAL_PORT    Default: 8788
  LLM_PORTAL_HOST    Default: 0.0.0.0

Examples:
  $SCRIPT_DIR/llm_portal start --dev      # Dev mode (foreground, auto-reload)
  $SCRIPT_DIR/llm_portal log 50           # Show last 50 log lines
  LLM_PORTAL_PORT=9000 $SCRIPT_DIR/llm_portal start  # Use different port

EOF
    exit 1
    ;;
esac
